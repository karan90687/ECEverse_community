<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECEverse – Community</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Modern, aesthetic community UI styles */
    :root {
      --bg: #ffffff;
      --card: #f8f9fa;
      --border: #e2e8f0;
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --danger: #ef4444;
      --text: #1f2937;
      --text-light: #6b7280;
      --success: #10b981;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      transition: var(--transition);
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial;
      height: 100vh;
      overflow: hidden;
      color: var(--text);
    }

    header {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 70px;
      box-sizing: border-box;
      box-shadow: var(--shadow);
    }

    header .left {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      color: var(--text);
      font-weight: 700;
    }

    header .user {
      color: var(--text-light);
      font-size: 14px;
      background: var(--card);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .wrap {
      padding: 0;
      width: 100%;
      height: calc(100vh - 70px);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 18px;
      font-weight: 600;
    }

    .muted {
      color: var(--text-light);
      font-size: 14px;
      line-height: 1.5;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 500;
      transition: var(--transition);
    }

    button:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-danger {
      background: var(--danger);
      border: none;
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
    }

    /* Community room */
    .room {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 16px;
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
      background: var(--bg);
    }

    .room .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .panel h4 {
      margin: 16px 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
    }

    .list {
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
    }

    .list .item {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .list .item:hover {
      background: rgba(79, 70, 229, 0.05);
      border-color: var(--primary-light);
    }

    .badge {
      font-size: 12px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      border-radius: 999px;
      color: var(--text-light);
      background: white;
      font-weight: 500;
    }

    .center {
      display: flex;
      flex-direction: column;
    }

    .topbar {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
    }

    .topbar .title {
      font-weight: 700;
      font-size: 18px;
    }

    #messages {
      flex: 1;
      overflow: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg);
    }

    .msg {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      background: #fff;
      position: relative;
      cursor: context-menu;
      transition: var(--transition);
      animation: fadeIn 0.3s ease;
    }

    .msg:hover {
      background-color: #f9fafb;
      box-shadow: var(--shadow);
    }

    .msg .meta {
      font-size: 13px;
      color: var(--text-light);
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      align-items: center;
    }
/* Online members list styling */
#onlineList {
  max-height: 200px;
  overflow-y: auto;
}

#onlineList .item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
}

.online {
  color: var(--success);
  font-weight: bold;
  font-size: 16px;
}

/* Back button in messages view */
#messagesBackBtn {
  margin: 16px;
  align-self: flex-start;
}
    .composer {
      display: flex;
      gap: 12px;
      border-top: 1px solid var(--border);
      padding: 16px;
      background: white;
    }

    .composer input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
    }

    .composer input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .row-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .hint {
      padding: 16px;
      background: #f9fafb;
      border-top: 1px solid var(--border);
      font-size: 14px;
      color: var(--text);
    }

    .hidden {
      display: none !important;
    }

    .online {
      color: var(--success);
      font-weight: 600;
    }

    .collapsed .list {
      display: none;
    }

    .icon-btn {
      background: none;
      border: none;
      padding: 6px;
      cursor: pointer;
      color: var(--text-light);
      border-radius: 6px;
      transition: var(--transition);
    }

    .icon-btn:hover {
      color: var(--primary);
      background: rgba(79, 70, 229, 0.1);
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--primary);
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .back-btn:hover {
      background: rgba(79, 70, 229, 0.1);
    }

    .member-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .member-modal-content {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      max-width: 450px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .member-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .member-modal-header h3 {
      margin: 0;
      font-weight: 600;
    }

    .member-modal-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .member-modal-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .member-modal-item:hover {
      background: rgba(79, 70, 229, 0.05);
    }

    .member-modal-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      flex-shrink: 0;
    }

    /* Message context menu */
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      z-index: 1000;
      display: none;
      flex-direction: column;
      min-width: 180px;
      overflow: hidden;
      animation: scaleIn 0.15s ease;
    }

    .context-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: var(--transition);
    }

    .context-menu-item:hover {
      background-color: #f0f5ff;
    }

    .context-menu-divider {
      height: 1px;
      background-color: var(--border);
      margin: 4px 0;
    }

    .reaction-bar {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .reaction {
      background: #f0f5ff;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
    }

    .reaction:hover {
      background: #e1e9ff;
      transform: scale(1.1);
    }

    .user-reacted {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Message actions */
    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .message-actions button {
      font-size: 12px;
      padding: 4px 8px;
      display: flex;
      align-items: center;
    }

    .message-actions button svg {
      margin-right: 4px;
    }

    .message-actions button.saved {
      color: var(--primary);
    }

    /* Answer section styles */
    .answers-section {
      transition: var(--transition);
      margin-top: 12px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }

    .answer {
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f9fafb;
      transition: var(--transition);
    }

    .answer:hover {
      background: #f0f5ff !important;
    }

    .answer-composer {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .answer-composer input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    /* Toggle icon animation */
    .toggle-icon {
      transition: transform 0.3s ease;
    }

    .collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    /* Navigation item hover effects */
    #navigationSection .item:hover {
      background: rgba(79, 70, 229, 0.05);
      border-color: var(--primary-light);
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .room {
        grid-template-columns: 240px 1fr;
      }
      
      .room .panel:last-child {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .room {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .room .panel:first-child,
      .room .panel:last-child {
        display: none;
      }
      
      .grid {
        grid-template-columns: 1fr;
        padding: 16px;
      }
    }
    .panel h4 {
  margin: 16px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
}
.panel h4 {
  margin: 16px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 8px;
  transition: var(--transition);
}

.panel h4:hover {
  background: rgba(79, 70, 229, 0.05);
}
  </style>
</head>
<body>
  <header>
    <div class="left">
      <button class="back-btn" id="headerBackBtn" style="display: none;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Back
      </button>
      <h1>ECEverse Communities</h1>
      <span id="userEmail" class="user"></span>
    </div>
    <div class="row-actions">
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Community chooser -->
    <div id="chooseView">
      <div class="grid">
        <div class="card" onclick="openCommunity('general')">
          <h3>General</h3>
          <div class="muted">Discuss general topics and announcements with the ECEverse community.</div>
          <div style="margin-top:16px;display:flex;gap:10px;align-items:center">
            <span class="badge"><span id="generalCount">0</span> members</span>
            <button class="btn-primary">Join Community</button>
          </div>
        </div>
        <div class="card" onclick="openCommunity('industry')">
          <h3>Industry</h3>
          <div class="muted">Share industry insights, opportunities, and professional discussions.</div>
          <div style="margin-top:16px;display:flex;gap:10px;align-items:center">
            <span class="badge"><span id="industryCount">0</span> members</span>
            <button class="btn-primary">Join Community</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Community room -->
    <div id="roomView" class="room hidden">
      <!-- Left: Navigation & Members -->
      <div class="panel">
        <!-- Navigation buttons -->
        <!-- Navigation buttons -->
<!-- Saved Problems button -->
<h4 onclick="showSavedMessages()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
  <span style="display: flex; align-items: center; gap: 8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M5 5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V21L12 17.5L5 21V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Saved Problems
  </span>
</h4>

<!-- My Discussion button -->
<h4 onclick="showMyDiscussions()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
  <span style="display: flex; align-items: center; gap: 8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M16 10L20 6L16 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 6H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    My Discussion
  </span>
</h4>

        <h4 onclick="showAllMembers()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; margin-top: 16px;">
  <span style="display: flex; align-items: center; gap: 8px;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M17 20H22V18C22 15.7909 20.2091 14 18 14C16.1362 14 14.57 15.2748 14.126 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M1 18V20H6V18C6 15.7909 7.79086 14 10 14C12.2091 14 14 15.7909 14 18V20H19V18C19 14.134 15.866 11 12 11C8.13401 11 5 14.134 5 18Z" stroke="currentColor" stroke-width="2"/>
    </svg>
    Members
    <span class="badge" id="membersCount" style="margin-left: 8px;">0</span>
  </span>
</h4>




<div class="list" id="membersList"></div>
        
        <div class="list" id="onlineList"></div>
      </div>

      <!-- Center: Chat -->
      <div class="panel center">
        <div class="topbar">
          <div>
            <span class="title" id="roomTitle">#general</span>
            <span class="badge" id="memberBadge">0 members</span>
          </div>
          <div class="row-actions">
            <button id="joinBtn" class="btn-primary">Join Community</button>
            <button id="exitBtn" class="btn-danger">Exit</button>
            <button class="back-btn" id="roomBackBtn">
              <!-- Back button content -->
            </button>
          </div>
        </div>

        <div id="messages"></div>

        <div id="nonMemberHint" class="hint hidden">
          You can view messages, but you must <b>join this community</b> to chat.
        </div>

        <div class="composer" id="composerRow">
          <input id="messageInput" type="text" placeholder="Type your message…" />
          <button class="btn-primary" id="sendBtn">Send</button>
          <button id="clearBtn">Clear Chat</button>
        </div>
      </div>

      <!-- Right: Channels (static placeholders) -->
      <div class="panel">
        <h4 onclick="toggleSection('channelsSection')" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
  <span style="display: flex; align-items: center;">
    Channels
    <span class="badge" style="margin-left: 8px;">4</span>
  </span>
</h4>
        <div class="list" id="channelsList">
          <div class="item"><span># general-chat</span></div>
          <div class="item"><span># introductions</span></div>
          <div class="item"><span># help</span></div>
          <div class="item"><span># resources</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" onclick="reactToMessage('👍')">
      <span>👍 Like</span>
    </div>
    <div class="context-menu-item" onclick="reactToMessage('❤️')">
      <span>❤️ Love</span>
    </div>
    <div class="context-menu-item" onclick="reactToMessage('😂')">
      <span>😂 Laugh</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="deleteMessageForMe()">
      <span>Delete for me</span>
    </div>
    <div class="context-menu-item" id="deleteForEveryoneBtn" onclick="deleteMessageForEveryone()">
      <span>Delete for everyone</span>
    </div>
    <div class="context-menu-item" onclick="copyMessageText()">
      <span>Copy text</span>
    </div>
  </div>

  <!-- Members Modal -->
  <div id="membersModal" class="member-modal hidden">
    <div class="member-modal-content">
      <div class="member-modal-header">
        <h3>All Community Members</h3>
        <button class="icon-btn" onclick="hideAllMembers()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="member-modal-list" id="allMembersList">
        <!-- Members will be populated here -->
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    /********** Firebase SDKs **********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, 
      collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc,
      getDocs, where
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import {
      getDatabase, ref, onValue, set, get, child, serverTimestamp as rtdbServerTimestamp, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    /********** Config **********/
   const firebaseConfig = {
  apiKey: "AIzaSyDvuHF3zAU9XJtoPyxpXDoyF3-FbyznPiE",
  authDomain: "coreverse-cadd5.firebaseapp.com",
  databaseURL: "https://coreverse-cadd5-default-rtdb.firebaseio.com",
  projectId: "coreverse-cadd5",
  storageBucket: "coreverse-cadd5.firebasestorage.app",
  messagingSenderId: "484740921978",
  appId: "1:484740921978:web:e882314214032bfbc2d9c3",
  measurementId: "G-TJEW9MRPH0"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    /********** State **********/
    let currentUser = null;
    let currentUsername = "";
    let currentCommunity = null;
    let messagesUnsub = null;
    let membersUnsub = null;
    let presenceUnsub = null;
    let isMember = false;
    let clearedChats = {}; // Track cleared chats per community
    let currentMessageId = null;
    let currentMessageUserId = null;

    /********** DOM **********/
    const userEmailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const headerBackBtn = document.getElementById('headerBackBtn');
    const roomBackBtn = document.getElementById('roomBackBtn');
    const contextMenu = document.getElementById('contextMenu');
    const deleteForEveryoneBtn = document.getElementById('deleteForEveryoneBtn');

    const chooseView = document.getElementById('chooseView');
    const roomView = document.getElementById('roomView');
    const roomTitle = document.getElementById('roomTitle');
    const memberBadge = document.getElementById('memberBadge');

    const membersList = document.getElementById('membersList');
    const onlineList = document.getElementById('onlineList');
    const membersCount = document.getElementById('membersCount');
    const onlineCount = document.getElementById('onlineCount');

    const joinBtn = document.getElementById('joinBtn');
    const exitBtn = document.getElementById('exitBtn');

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const composerRow = document.getElementById('composerRow');
    const nonMemberHint = document.getElementById('nonMemberHint');

    const generalCount = document.getElementById('generalCount');
    const industryCount = document.getElementById('industryCount');

    const membersModal = document.getElementById('membersModal');
    const allMembersList = document.getElementById('allMembersList');

    /********** UI Functions **********/
    window.toggleSection = function(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('collapsed');
        
        // Update the toggle icon for navigation section
        if (sectionId === 'navigationSection') {
          const toggleIcon = document.querySelector('#navigationSection').closest('.panel').querySelector('.toggle-icon');
          if (toggleIcon) {
            toggleIcon.style.transform = section.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0deg)';
          }
        }
      }
    };

    window.showAllMembers = async function() {
  if (!currentCommunity) return;
  
  try {
    allMembersList.innerHTML = '';
    
    // Get community members
    const cRef = doc(db, "communities", currentCommunity);
    const cSnap = await getDoc(cRef);
    const memberIds = cSnap.exists() ? (cSnap.data().members || []) : [];
    
    // Get online members from presence
    const presenceSnapshot = await get(ref(rtdb, `presence/${currentCommunity}`));
    const onlineMembers = presenceSnapshot.exists() ? presenceSnapshot.val() : {};
    
    for (const uid of memberIds) {
      try {
        const uSnap = await get(child(ref(rtdb), `users/${uid}`));
        const userData = uSnap.exists() ? uSnap.val() : {};
        const username = userData.username || userData.email?.split('@')[0] || uid;
        
        const isOnline = onlineMembers[uid] && onlineMembers[uid].state === 'online';
        
        const memberItem = document.createElement('div');
        memberItem.className = 'member-modal-item';
        memberItem.innerHTML = `
          <div class="member-modal-avatar">${username.charAt(0).toUpperCase()}</div>
          <div style="flex: 1;">
            <div>${escapeHtml(username)} ${uid === currentUser.uid ? '(You)' : ''}</div>
            <div style="font-size: 12px; color: #6b7280;">${isOnline ? 'Online' : 'Offline'}</div>
          </div>
          ${isOnline ? '<span class="online">●</span>' : ''}
        `;
        
        allMembersList.appendChild(memberItem);
      } catch (error) {
        console.error("Error loading member:", error);
      }
    }
    
    membersModal.classList.remove('hidden');
  } catch (error) {
    console.error("Error loading all members:", error);
  }
};
    window.hideAllMembers = function() {
      membersModal.classList.add('hidden');
    };

    /********** Auth **********/
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      userEmailEl.textContent = user.email;

      // get username from RTDB users/{uid}
      try {
        const snap = await get(child(ref(rtdb), `users/${user.uid}`));
        currentUsername = snap.exists() ? (snap.val().username || user.email.split('@')[0]) : user.email.split('@')[0];
      } catch {
        currentUsername = user.email.split('@')[0];
      }

      // Load cleared chats from localStorage
      const savedClearedChats = localStorage.getItem('clearedChats');
      if (savedClearedChats) {
        clearedChats = JSON.parse(savedClearedChats);
      }

      // counts
      updateCounts();
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    // Back button handlers
    headerBackBtn.addEventListener('click', goBackToHome);
    roomBackBtn.addEventListener('click', goBackToHome);

    function goBackToHome() {
      stopListeners();
      roomView.classList.add('hidden');
      chooseView.classList.remove('hidden');
      headerBackBtn.style.display = 'none';
      currentCommunity = null;
    }

    async function updateCounts(){
      try{
        const gen = await getDoc(doc(db, "communities", "general"));
        generalCount.textContent = gen.exists() ? (gen.data().members || []).length : 0;

        const ind = await getDoc(doc(db, "communities", "industry"));
        industryCount.textContent = ind.exists() ? (ind.data().members || []).length : 0;
      }catch(e){ console.warn(e); }
    }

    /********** Open a community (read-only if not member) **********/
    window.openCommunity = async (communityId) => {
      if (!currentUser) return;

      // stop old listeners
      stopListeners();
      clearLists();
      messagesDiv.innerHTML = "";

      currentCommunity = communityId;
      roomTitle.textContent = `# ${communityId}`;

      // Show room and back button
      chooseView.classList.add('hidden');
      roomView.classList.remove('hidden');
      headerBackBtn.style.display = 'flex';

      // Check membership
      const cRef = doc(db, "communities", communityId);
      const cSnap = await getDoc(cRef);
      const members = cSnap.exists() ? (cSnap.data().members || []) : [];
      isMember = members.includes(currentUser.uid);

      // UI manage
      setChatMode(isMember);
      memberBadge.textContent = `${members.length} members`;
      membersCount.textContent = members.length;

      // Listen to messages (read-only for everyone)
      listenMessages(communityId);

      // Load members list
      listenMembers(communityId);

      // Presence: only attach if member and viewing this room
      attachPresenceIfMember();
    };

    function setChatMode(member){
      if (member){
        joinBtn.classList.add('hidden');
        composerRow.classList.remove('hidden');
        nonMemberHint.classList.add('hidden');
        sendBtn.disabled = false;
        messageInput.disabled = false;
      } else {
        joinBtn.classList.remove('hidden');
        composerRow.classList.add('hidden');
        nonMemberHint.classList.remove('hidden');
        sendBtn.disabled = true;
        messageInput.disabled = true;
      }
    }

    /********** Join community (required to chat & to be online) **********/
    joinBtn.addEventListener('click', async () => {
      if (!currentUser || !currentCommunity) return;
      try{
        const cRef = doc(db, "communities", currentCommunity);
        await setDoc(cRef, { members: arrayUnion(currentUser.uid) }, { merge:true });
        isMember = true;
        setChatMode(true);
        updateCounts();
        // re-attach presence now that user is member
        attachPresenceIfMember();
      }catch(e){
        alert("Failed to join. Try again.");
        console.error(e);
      }
    });

    /********** Exit community (removes from backend & presence) **********/
    exitBtn.addEventListener('click', async () => {
      if (!currentUser || !currentCommunity) return;
      if (!confirm("Are you sure you want to exit this community?")) return;

      try{
        const cRef = doc(db, "communities", currentCommunity);
        await updateDoc(cRef, { members: arrayRemove(currentUser.uid) });
        // remove presence entry
        await remove(ref(rtdb, `presence/${currentCommunity}/${currentUser.uid}`)).catch(()=>{});
        isMember = false;

        // After exit, go back to chooser
        goBackToHome();
        updateCounts();
        alert("You left the community.");
      }catch(e){
        alert("Failed to exit. Try again.");
        console.error(e);
      }
    });

    /********** Messages **********/
    async function sendMessage(){
      if (!currentUser || !currentCommunity) return;
      if (!isMember){
        alert("Join this community to send messages.");
        return;
      }
      const text = messageInput.value.trim();
      if (!text) return;

      try{
        const messageData = {
          userId: currentUser.uid,
          username: currentUsername || currentUser.email,
          message: text,
          timestamp: serverTimestamp()
        };
        
        // Check if this is a reply to another message
        const replyingTo = sessionStorage.getItem('replyingTo');
        if (replyingTo) {
          messageData.replyingTo = replyingTo;
          sessionStorage.removeItem('replyingTo');
        }
        
        await addDoc(collection(db, "communities", currentCommunity, "messages"), messageData);
        messageInput.value = "";
      }catch(e){
        console.error(e);
        alert("Error sending message.");
      }
    }
    
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

    clearBtn.addEventListener('click', () => {
      if (!currentCommunity) return;
      
      if (confirm("Clear chat history for yourself only? Other members will still see all messages.")) {
        // Store cleared state for this community
        clearedChats[currentCommunity] = new Date().toISOString();
        localStorage.setItem('clearedChats', JSON.stringify(clearedChats));
        
        // Clear messages from view
        messagesDiv.innerHTML = "";
        
        // Add a note that chat was cleared
        const note = document.createElement('div');
        note.className = 'hint';
        note.textContent = 'You cleared the chat history. Others can still see all messages.';
        messagesDiv.appendChild(note);
      }
    });

    function listenMessages(communityId){
  // Hide back button when viewing regular messages
  if (document.getElementById('messagesBackBtn')) {
    document.getElementById('messagesBackBtn').style.display = 'none';
  }
      if (messagesUnsub) messagesUnsub();
      const qy = query(collection(db, "communities", communityId, "messages"), orderBy("timestamp","asc"));
      messagesUnsub = onSnapshot(qy, (snap)=>{
        messagesDiv.innerHTML = "";
        
        // Check if user cleared this chat
        const clearedAt = clearedChats[communityId] ? new Date(clearedChats[communityId]) : null;
        
        // Get deleted messages for this user
        const deletedMessages = JSON.parse(localStorage.getItem('deletedMessages') || '{}');
        const userDeletedMessages = deletedMessages[communityId] || [];
        
        snap.forEach(d=>{
          const m = d.data();
          
          // Skip messages that were sent before the user cleared the chat
          if (clearedAt && m.timestamp && m.timestamp.toDate() < clearedAt) {
            return;
          }
          
          // Skip messages that user has deleted for themselves
          if (userDeletedMessages.includes(d.id)) {
            return;
          }
          
          const div = document.createElement('div');
          div.className = 'msg';
          div.dataset.id = d.id;
          div.dataset.userId = m.userId;
          const time = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';

          // Add reactions if they exist
          let reactionsHtml = '';
          if (m.reactions && Object.keys(m.reactions).length > 0) {
            reactionsHtml = '<div class="reaction-bar">';
            for (const [emoji, users] of Object.entries(m.reactions)) {
              const userReacted = users.includes(currentUser.uid);
              reactionsHtml += `<span class="reaction ${userReacted ? 'user-reacted' : ''}" onclick="quickReact('${d.id}', '${emoji}')">${emoji} ${users.length}</span>`;
            }
            reactionsHtml += '</div>';
          }

          // Check if message is saved by current user
          const isSaved = m.savedBy && m.savedBy.includes(currentUser.uid);

          // Check if message has answers
          const hasAnswers = m.answers && m.answers.length > 0;

          // Action buttons
          const actionButtons = `
            <div class="message-actions">
              <button class="icon-btn" onclick="likeMessage('${d.id}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                  <path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.5783 8.50903 2.9987 7.05 2.9987C5.59096 2.9987 4.19169 3.5783 3.16 4.61C2.1283 5.6417 1.54871 7.04097 1.54871 8.5C1.54871 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7563 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39465C21.7563 5.72719 21.351 5.12076 20.84 4.61V4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Like
              </button>
              <button class="icon-btn" onclick="toggleAnswerSection('${d.id}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                  <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 10L20 6L16 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M20 6H10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Answer ${hasAnswers ? `(${m.answers.length})` : ''}
              </button>
              <button class="icon-btn ${isSaved ? 'saved' : ''}" onclick="saveMessage('${d.id}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="${isSaved ? 'currentColor' : 'none'}" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                  <path d="M5 5C5 3.89543 5.89543 3 7 3H17C18.1046 3 19 3.89543 19 5V21L12 17.5L5 21V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                ${isSaved ? 'Saved' : 'Save'}
              </button>
            </div>
          `;

          // Answers section
          const answersHtml = `
            <div class="answers-section" id="answers-${d.id}" style="display: none;">
              <div class="answers-list" id="answers-list-${d.id}">
                ${hasAnswers ? m.answers.map(answer => `
                  <div class="answer">
                    <div style="font-size: 12px; color: #6b7280;">
                      <strong>${answer.username}</strong> • ${answer.timestamp?.toDate ? answer.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}
                    </div>
                    <div>${escapeHtml(answer.message || '')}</div>
                  </div>
                `).join('') : '<div class="hint" style="padding: 8px; text-align: center;">No answers yet</div>'}
              </div>
              <div class="answer-composer">
                <input type="text" id="answer-input-${d.id}" placeholder="Write your answer...">
                <button class="btn-primary" onclick="submitAnswer('${d.id}')">Post Answer</button>
              </div>
            </div>
          `;

          // Highlight user's own messages
          const isOwnMessage = m.userId === currentUser.uid;

          div.innerHTML = `
            <div class="meta">
              <span style="font-weight: 600;">${m.username || 'User'}</span>
              <span>${time}</span>
            </div>
            <div>${escapeHtml(m.message || '')}</div>
            ${reactionsHtml}
            ${actionButtons}
            ${answersHtml}
          `;

          // Add subtle background for own messages
          if (isOwnMessage) {
            div.style.background = 'rgba(79, 70, 229, 0.05)';
            div.style.borderColor = 'rgba(79, 70, 229, 0.2)';
          }
          messagesDiv.appendChild(div);
        });
        
        // Add cleared note if applicable
        if (clearedAt) {
          const note = document.createElement('div');
          note.className = 'hint';
          note.textContent = 'You cleared previous messages. Others can still see all messages.';
          messagesDiv.appendChild(note);
        }
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    /********** Message Context Menu **********/
    // Show context menu on right-click
    document.addEventListener('contextmenu', function(e) {
      const messageElement = e.target.closest('.msg');
      if (messageElement) {
        e.preventDefault();
        currentMessageId = messageElement.dataset.id;
        currentMessageUserId = messageElement.dataset.userId;
        
        // Position the context menu
        contextMenu.style.display = 'flex';
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        
        // Hide delete for everyone if user doesn't own the message
        if (currentMessageUserId !== currentUser.uid) {
          deleteForEveryoneBtn.style.display = 'none';
        } else {
          deleteForEveryoneBtn.style.display = 'flex';
        }
      }
    });

    // Hide context menu on click elsewhere
    document.addEventListener('click', function() {
      contextMenu.style.display = 'none';
    });

    // Prevent context menu from closing when clicking on it
    contextMenu.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    // React to message
    async function reactToMessage(reaction) {
      if (!currentMessageId || !currentCommunity) return;
      
      try {
        const messageRef = doc(db, "communities", currentCommunity, "messages", currentMessageId);
        const messageSnap = await getDoc(messageRef);
        
        if (messageSnap.exists()) {
          const messageData = messageSnap.data();
          const reactions = messageData.reactions || {};
          
          // Toggle reaction
          if (reactions[reaction] && reactions[reaction].includes(currentUser.uid)) {
            // Remove reaction
            const updatedUsers = reactions[reaction].filter(uid => uid !== currentUser.uid);
            if (updatedUsers.length === 0) {
              delete reactions[reaction];
            } else {
              reactions[reaction] = updatedUsers;
            }
          } else {
            // Add reaction
            if (!reactions[reaction]) {
              reactions[reaction] = [];
            }
            reactions[reaction].push(currentUser.uid);
          }
          
          // Update message with new reactions
          await updateDoc(messageRef, { reactions });
        }
      } catch (error) {
        console.error("Error reacting to message:", error);
      }
      
      contextMenu.style.display = 'none';
    }

    // Delete message for me only
    async function deleteMessageForMe() {
      if (!currentMessageId || !currentCommunity) return;
      
      try {
        // Store deleted message ID in localStorage
        const deletedMessages = JSON.parse(localStorage.getItem('deletedMessages') || '{}');
        if (!deletedMessages[currentCommunity]) {
          deletedMessages[currentCommunity] = [];
        }
        deletedMessages[currentCommunity].push(currentMessageId);
        localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
        
        // Remove message from view
        const messageElement = document.querySelector(`.msg[data-id="${currentMessageId}"]`);
        if (messageElement) {
          messageElement.remove();
        }
      } catch (error) {
        console.error("Error deleting message for me:", error);
      }
      
      contextMenu.style.display = 'none';
    }

    // Delete message for everyone
    async function deleteMessageForEveryone() {
      if (!currentMessageId || !currentCommunity) return;
      
      if (confirm("Are you sure you want to delete this message for everyone?")) {
        try {
          const messageRef = doc(db, "communities", currentCommunity, "messages", currentMessageId);
          await deleteDoc(messageRef);
        } catch (error) {
          console.error("Error deleting message for everyone:", error);
        }
      }
      
      contextMenu.style.display = 'none';
    }

    // Copy message text
    function copyMessageText() {
      if (!currentMessageId) return;
      
      const messageElement = document.querySelector(`.msg[data-id="${currentMessageId}"]`);
      if (messageElement) {
        const messageText = messageElement.querySelector('div:last-child').textContent;
        navigator.clipboard.writeText(messageText).then(() => {
          // Show copied feedback (you could add a toast notification here)
        });
      }
      
      contextMenu.style.display = 'none';
    }

    // Quick react function for clicking on existing reactions
    async function quickReact(messageId, emoji) {
      if (!currentCommunity) return;
      
      try {
        const messageRef = doc(db, "communities", currentCommunity, "messages", messageId);
        const messageSnap = await getDoc(messageRef);
        
        if (messageSnap.exists()) {
          const messageData = messageSnap.data();
          const reactions = messageData.reactions || {};
          
          // Toggle reaction
          if (reactions[emoji] && reactions[emoji].includes(currentUser.uid)) {
            // Remove reaction
            const updatedUsers = reactions[emoji].filter(uid => uid !== currentUser.uid);
            if (updatedUsers.length === 0) {
              delete reactions[emoji];
            } else {
              reactions[emoji] = updatedUsers;
            }
          } else {
            // Add reaction
            if (!reactions[emoji]) {
              reactions[emoji] = [];
            }
            reactions[emoji].push(currentUser.uid);
          }
          
          // Update message with new reactions
          await updateDoc(messageRef, { reactions });
        }
      } catch (error) {
        console.error("Error with quick reaction:", error);
      }
    }

    /********** Answer Functionality **********/
    // Toggle answer section
    function toggleAnswerSection(messageId) {
      const answerSection = document.getElementById(`answers-${messageId}`);
      if (answerSection.style.display === 'none') {
        answerSection.style.display = 'block';
      } else {
        answerSection.style.display = 'none';
      }
    }

    // Submit answer
    async function submitAnswer(messageId) {
      if (!currentUser || !currentCommunity) return;
      
      const answerInput = document.getElementById(`answer-input-${messageId}`);
      const answerText = answerInput.value.trim();
      
      if (!answerText) return;
      
      try {
        const messageRef = doc(db, "communities", currentCommunity, "messages", messageId);
        const messageSnap = await getDoc(messageRef);
        
        if (messageSnap.exists()) {
          const messageData = messageSnap.data();
          const answers = messageData.answers || [];
          
          // Add new answer
          answers.push({
            userId: currentUser.uid,
            username: currentUsername || currentUser.email,
            message: answerText,
            timestamp: serverTimestamp()
          });
          
          // Update message with new answer
          await updateDoc(messageRef, { answers });
          
          // Clear input
          answerInput.value = '';
          
          // Refresh the answers list
          const answersList = document.getElementById(`answers-list-${messageId}`);
          answersList.innerHTML = answers.map(answer => `
            <div class="answer">
              <div style="font-size: 12px; color: #6b7280;">
                <strong>${answer.username}</strong> • ${answer.timestamp?.toDate ? answer.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}
              </div>
              <div>${escapeHtml(answer.message || '')}</div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error("Error submitting answer:", error);
      }
    }

    // Update the answerMessage function
    async function answerMessage(messageId) {
      if (!currentUser || !currentCommunity) return;
      
      try {
        const messageRef = doc(db, "communities", currentCommunity, "messages", messageId);
        const messageSnap = await getDoc(messageRef);
        
        if (messageSnap.exists()) {
          const messageData = messageSnap.data();
          
          // Focus the input and add a mention
          messageInput.value = `@${messageData.username || 'User'} `;
          messageInput.focus();
          
          // Store the message being replied to
          sessionStorage.setItem('replyingTo', messageId);
          
          // Show the answer section
          toggleAnswerSection(messageId);
        }
      } catch (error) {
        console.error("Error preparing to answer message:", error);
      }
    }

    /********** Members & Presence **********/
    function listenMembers(communityId){
      // Firestore members list
      if (membersUnsub) membersUnsub();
      membersUnsub = onSnapshot(doc(db, "communities", communityId), async (snap)=>{
        const ids = snap.exists() ? (snap.data().members || []) : [];
        memberBadge.textContent = `${ids.length} members`;
        membersCount.textContent = ids.length;
        
        // populate members (names from RTDB users/{uid})
        membersList.innerHTML = "";
        for (const uid of ids){
          const uSnap = await get(child(ref(rtdb), `users/${uid}`)).catch(()=>null);
          const uname = uSnap && uSnap.exists() ? (uSnap.val().username || (uSnap.val().email?.split('@')[0]) || uid) : uid;
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `<span>${escapeHtml(uname)} ${uid === currentUser.uid ? '(You)' : ''}</span>`;
          membersList.appendChild(row);
        }
      });

      // RTDB presence for this community
      if (presenceUnsub) presenceUnsub();
      presenceUnsub = onValue(ref(rtdb, `presence/${communityId}`), (snap)=>{
        onlineList.innerHTML = "";
        const val = snap.val() || {};
        let onlineCounter = 0;
        
        // val = { uid: { state:'online'|'offline', last_changed, username } }
        Object.entries(val).forEach(([uid, p])=>{
          if (p && p.state === 'online'){
            onlineCounter++;
            const row = document.createElement('div');
            row.className = 'item';
            row.innerHTML = `<span>${escapeHtml(p.username || uid)}</span><span class="online">●</span>`;
            onlineList.appendChild(row);
          }
        });
        
        onlineCount.textContent = onlineCounter;
      });
    }

    // Attach presence only if user is a member AND currently viewing the community
    async function attachPresenceIfMember(){
      if (!currentUser || !currentCommunity) return;
      if (!isMember) return;

      const myPresenceRef = ref(rtdb, `presence/${currentCommunity}/${currentUser.uid}`);
      // Set online
      await set(myPresenceRef, {
        state: 'online',
        username: currentUsername || currentUser.email.split('@')[0],
        last_changed: rtdbServerTimestamp()
      }).catch(()=>{});

      // Ensure offline on disconnect
      onDisconnect(myPresenceRef).set({
        state: 'offline',
        username: currentUsername || currentUser.email.split('@')[0],
        last_changed: rtdbServerTimestamp()
      });

      // Also react to tab visibility/network
      window.addEventListener('beforeunload', () => {
        // best-effort; onDisconnect covers most cases
      });
      document.addEventListener('visibilitychange', async () => {
        if (!currentCommunity || !isMember) return;
        if (document.visibilityState === 'visible'){
          await set(myPresenceRef, {
            state:'online',
            username: currentUsername || currentUser.email.split('@')[0],
            last_changed: rtdbServerTimestamp()
          }).catch(()=>{});
        } else {
          await set(myPresenceRef, {
            state:'offline',
            username: currentUsername || currentUser.email.split('@')[0],
            last_changed: rtdbServerTimestamp()
          }).catch(()=>{});
        }
      });
      window.addEventListener('online', async ()=>{
        if (!currentCommunity || !isMember) return;
        await set(myPresenceRef, { state:'online', username: currentUsername || currentUser.email.split('@')[0], last_changed: rtdbServerTimestamp() }).catch(()=>{});
      });
      window.addEventListener('offline', async ()=>{
        if (!currentCommunity || !isMember) return;
        await set(myPresenceRef, { state:'offline', username: currentUsername || currentUser.email.split('@')[0], last_changed: rtdbServerTimestamp() }).catch(()=>{});
      });
    }

    /********** Saved Messages & My Discussions **********/
    // Save message function
    async function saveMessage(messageId) {
      if (!currentUser || !currentCommunity) return;
      
      try {
        const messageRef = doc(db, "communities", currentCommunity, "messages", messageId);
        const messageSnap = await getDoc(messageRef);
        
        if (messageSnap.exists()) {
          const messageData = messageSnap.data();
          const savedBy = messageData.savedBy || [];
          
          // Toggle save status
          if (savedBy.includes(currentUser.uid)) {
            // Remove from saved
            await updateDoc(messageRef, {
              savedBy: arrayRemove(currentUser.uid)
            });
            
            // Remove from user's saved messages collection
            await deleteDoc(doc(db, "users", currentUser.uid, "savedMessages", messageId));
          } else {
            // Add to saved
            await updateDoc(messageRef, {
              savedBy: arrayUnion(currentUser.uid)
            });
            
            // Also save to user's saved messages collection
            await setDoc(doc(db, "users", currentUser.uid, "savedMessages", messageId), {
              communityId: currentCommunity,
              messageId: messageId,
              timestamp: serverTimestamp(),
              messageText: messageData.message, // Store message text for display
              username: messageData.username // Store username for display
            });
          }
          
          // Refresh the messages to update the save button state
          if (messagesUnsub) {
            messagesUnsub();
            listenMessages(currentCommunity);
          }
        }
      } catch (error) {
        console.error("Error saving message:", error);
      }
    }

    // Like message function
    async function likeMessage(messageId) {
      await reactToMessage('👍');
    }

    // Show saved messages
   // Show saved messages
async function showSavedMessages() {
  if (!currentUser) return;
  
  try {
    // Add back button
    addBackButtonToMessagesView();
    document.getElementById('messagesBackBtn').style.display = 'flex';
    
    // Clear current view
    messagesDiv.innerHTML = '';
    
    // Get saved messages
    const savedMessagesRef = collection(db, "users", currentUser.uid, "savedMessages");
    const savedMessagesSnap = await getDocs(query(savedMessagesRef, orderBy("timestamp", "desc")));
    
    if (savedMessagesSnap.empty) {
      messagesDiv.innerHTML = '<div class="hint">You haven\'t saved any messages yet.</div>';
      return;
    }
        
        // Fetch and display each saved message
        for (const docSnap of savedMessagesSnap.docs) {
          const savedData = docSnap.data();
          const messageRef = doc(db, "communities", savedData.communityId, "messages", savedData.messageId);
          const messageSnap = await getDoc(messageRef);
          
          if (messageSnap.exists()) {
            const m = messageSnap.data();
            const time = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
            
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `
              <div class="meta">
                <span style="font-weight: 600;">${m.username || 'User'}</span>
                <span>${time}</span>
                <span class="badge">#${savedData.communityId}</span>
              </div>
              <div>${escapeHtml(m.message || '')}</div>
              <div class="message-actions" style="display: flex; gap: 8px; margin-top: 8px;">
                <button class="icon-btn" onclick="openCommunity('${savedData.communityId}')">
                  Go to Community
                </button>
                <button class="icon-btn" onclick="unsaveMessage('${savedData.messageId}', '${savedData.communityId}')">
                  Remove
                </button>
              </div>
            `;
            
            messagesDiv.appendChild(div);
          }
        }
        } catch (error) {
    console.error("Error loading saved messages:", error);
    messagesDiv.innerHTML = '<div class="hint">Error loading saved messages.</div>';
  }
}
    // Unsave message
    async function unsaveMessage(messageId, communityId) {
      if (!currentUser) return;
      
      try {
        // Remove from message's savedBy array
        const messageRef = doc(db, "communities", communityId, "messages", messageId);
        await updateDoc(messageRef, {
          savedBy: arrayRemove(currentUser.uid)
        });
        
        // Remove from user's saved messages
        await deleteDoc(doc(db, "users", currentUser.uid, "savedMessages", messageId));
        
        // Refresh the view
        showSavedMessages();
      } catch (error) {
        console.error("Error unsaving message:", error);
      }
    }

    // Show my discussions
    async function showMyDiscussions() {
  if (!currentUser) return;
  
  try {
    // Add back button
    addBackButtonToMessagesView();
    document.getElementById('messagesBackBtn').style.display = 'flex';
    
    // Clear current view
    messagesDiv.innerHTML = '';
        
        // Get all communities the user is a member of
        const userCommunities = [];
        const communitiesSnap = await getDocs(collection(db, "communities"));
        
        for (const docSnap of communitiesSnap.docs) {
          const communityData = docSnap.data();
          if (communityData.members && communityData.members.includes(currentUser.uid)) {
            userCommunities.push(docSnap.id);
          }
        }
        
        if (userCommunities.length === 0) {
          messagesDiv.innerHTML = '<div class="hint">You\'re not a member of any communities yet.</div>';
          return;
        }
        
        // Get all messages from user's communities where user is the author OR has answered
        let userMessages = [];
        let userAnswers = [];
        
        for (const communityId of userCommunities) {
          try {
            // Get messages where user is the author
            const messagesRef = collection(db, "communities", communityId, "messages");
            const messagesSnap = await getDocs(query(messagesRef, where("userId", "==", currentUser.uid), orderBy("timestamp", "desc")));
            
            messagesSnap.forEach(docSnap => {
              userMessages.push({
                id: docSnap.id,
                communityId: communityId,
                type: 'message',
                ...docSnap.data()
              });
            });
            
            // Get messages where user has answered
            const allMessagesSnap = await getDocs(query(messagesRef, orderBy("timestamp", "desc")));
            
            allMessagesSnap.forEach(docSnap => {
              const messageData = docSnap.data();
              if (messageData.answers) {
                const userAnswer = messageData.answers.find(answer => answer.userId === currentUser.uid);
                if (userAnswer) {
                  userAnswers.push({
                    id: docSnap.id,
                    communityId: communityId,
                    type: 'answer',
                    question: messageData.message,
                    questionAuthor: messageData.username,
                    answer: userAnswer,
                    timestamp: userAnswer.timestamp
                  });
                }
              }
            });
            } catch (error) {
    console.error("Error loading user discussions:", error);
    messagesDiv.innerHTML = '<div class="hint">Error loading your discussions.</div>';
  }
}

        
        if (userMessages.length === 0 && userAnswers.length === 0) {
          messagesDiv.innerHTML = '<div class="hint">You haven\'t posted any messages or answers yet.</div>';
          return;
        }
        
        // Combine and sort by timestamp (newest first)
        const allItems = [...userMessages, ...userAnswers];
        allItems.sort((a, b) => {
          const aTime = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : 0;
          const bTime = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : 0;
          return bTime - aTime;
        });
        
        // Display user's messages and answers
        allItems.forEach(item => {
          if (item.type === 'message') {
            const time = item.timestamp?.toDate ? item.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
            
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `
              <div class="meta">
                <span style="font-weight: 600;">You</span>
                <span>${time}</span>
                <span class="badge">#${item.communityId}</span>
                <span class="badge" style="background: #e0e7ff; color: var(--primary);">Your Question</span>
              </div>
              <div>${escapeHtml(item.message || '')}</div>
              <div class="message-actions">
                <button class="icon-btn" onclick="openCommunity('${item.communityId}')">
                  Go to Community
                </button>
              </div>
            `;
            
            messagesDiv.appendChild(div);
          } else if (item.type === 'answer') {
            const time = item.answer.timestamp?.toDate ? item.answer.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
            
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `
              <div class="meta">
                <span style="font-weight: 600;">You</span>
                <span>${time}</span>
                <span class="badge">#${item.communityId}</span>
                <span class="badge" style="background: #d1fae5; color: var(--success);">Your Answer</span>
              </div>
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">
                In response to <strong>${escapeHtml(item.questionAuthor)}'s</strong> question:
              </div>
              <div style="background: #f9fafb; padding: 8px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
                ${escapeHtml(item.question || '')}
              </div>
              <div><strong>Your answer:</strong> ${escapeHtml(item.answer.message || '')}</div>
              <div class="message-actions">
                <button class="icon-btn" onclick="openCommunity('${item.communityId}')">
                  Go to Community
                </button>
              </div>
            `;
            
            messagesDiv.appendChild(div);
          }
        });
      } catch (error) {
        console.error("Error loading user discussions:", error);
        messagesDiv.innerHTML = '<div class="hint">Error loading your discussions.</div>';
      }
    }

    /********** Utilities **********/
    function stopListeners(){
      if (messagesUnsub) { messagesUnsub(); messagesUnsub = null; }
      if (membersUnsub) { membersUnsub(); membersUnsub = null; }
      if (presenceUnsub) { presenceUnsub(); presenceUnsub = null; }
    }
    
    function clearLists(){
      membersList.innerHTML = "";
      onlineList.innerHTML = "";
    }
    
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
                                                                             
    /********** Global Function Declarations **********/
    window.saveMessage = saveMessage;
    window.likeMessage = likeMessage;
    window.answerMessage = answerMessage;
    window.showSavedMessages = showSavedMessages;
    window.showMyDiscussions = showMyDiscussions;
    window.unsaveMessage = unsaveMessage;
    window.toggleAnswerSection = toggleAnswerSection;
    window.submitAnswer = submitAnswer;
    
    /********** OPTIONAL: Auto-open last room via URL ?room=general **********/
    const params = new URLSearchParams(window.location.search);
    const pre = params.get('room');
    if (pre) {
      // Wait a tick for auth, then open
      const tryOpen = setInterval(()=>{
        if (currentUser){ clearInterval(tryOpen); openCommunity(pre); }
      }, 200);
    }
    // Function to show all members (opens the modal)
window.showAllMembers = async function() {
  if (!currentCommunity) return;
  
  try {
    allMembersList.innerHTML = '';
    
    // Get community members
    const cRef = doc(db, "communities", currentCommunity);
    const cSnap = await getDoc(cRef);
    const memberIds = cSnap.exists() ? (cSnap.data().members || []) : [];
    
    // Get online members from presence
    const presenceSnapshot = await get(ref(rtdb, `presence/${currentCommunity}`));
    const onlineMembers = presenceSnapshot.exists() ? presenceSnapshot.val() : {};
    
    for (const uid of memberIds) {
      try {
        const uSnap = await get(child(ref(rtdb), `users/${uid}`));
        const userData = uSnap.exists() ? uSnap.val() : {};
        const username = userData.username || userData.email?.split('@')[0] || uid;
        
        const isOnline = onlineMembers[uid] && onlineMembers[uid].state === 'online';
        
        const memberItem = document.createElement('div');
        memberItem.className = 'member-modal-item';
        memberItem.innerHTML = `
          <div class="member-modal-avatar">${username.charAt(0).toUpperCase()}</div>
          <div style="flex: 1;">
            <div>${escapeHtml(username)} ${uid === currentUser.uid ? '(You)' : ''}</div>
            <div style="font-size: 12px; color: #6b7280;">${isOnline ? 'Online' : 'Offline'}</div>
          </div>
          ${isOnline ? '<span class="online">●</span>' : ''}
        `;
        
        allMembersList.appendChild(memberItem);
      } catch (error) {
        console.error("Error loading member:", error);
      }
    }
    
    membersModal.classList.remove('hidden');
  } catch (error) {
    console.error("Error loading all members:", error);
  }
};
// Function to add back button to messages view
function addBackButtonToMessagesView() {
  // Create back button if it doesn't exist
  if (!document.getElementById('messagesBackBtn')) {
    const backButton = document.createElement('button');
    backButton.id = 'messagesBackBtn';
    backButton.className = 'back-btn';
    backButton.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back to Chat
    `;
    backButton.style.marginBottom = '16px';
    backButton.style.display = 'none';
    backButton.onclick = () => {
      // Clear messages and re-listen to current community
      messagesDiv.innerHTML = '';
      if (currentCommunity) {
        listenMessages(currentCommunity);
      }
      backButton.style.display = 'none';
    };
    
    // Insert back button at the top of messages div
    messagesDiv.parentNode.insertBefore(backButton, messagesDiv);
  }
}
  </script>
</body>
</html>